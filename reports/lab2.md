# Lab2 实验报告

李骋昊 2021010826

崇祯七甲辰二月廿三日丁酉

### Honor Code

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 **以下各位** 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

   -> 无

2. 此外，我也参考了 **以下资料** ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

   -> 无

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。





https://learningos.cn/rCore-Tutorial-Guide-2024S/chapter3/5exercise.html

## 做的更改：

1. 为MemorySet实现 mmap 和 munmap
2. 在以上的基础上，为`TASK_MANAGER`实现 mmap 和 munmap
3. 在以上的基础上实现`sys_mmap`系统调用
4. 实现utility函数`copy_into_translated_byte_bytter`, 手动查页表，并逐字节复制
5. 利用以上的函数,重新实现`sys_get_time`和`sys_task_info`系统调用
   

## 问答作业：

### SV39页表项

63-54 : Reserved
53-28 : PPN[2] 物理页号
27-19 : PPN[1] 物理页号
18-10 : PPN[0] 物理页号
9-8: RSW 控制页面读写权限，以及是否只在S态下可以访问
7： D， 标记页表项对应的虚拟页是否被修改过
6： A， 标记页表项对应的虚拟页是否被访问过
5： G 标记对应的转换是全局的还是属于某一个特定的进程下的
4： U 设定对应虚拟页是否在用户态下允许访问
3： X 设定对应虚拟页是否可执行
2： W 设定对应虚拟页是否可写
1： R 设定对应虚拟页是否可读
0： V， 为1时该页表项有效

### 缺页
#### 请问哪些异常可能是缺页导致的？

Risc-V中，`Instruction Page fault`,  `Load Page Fault`,   `Store/AMO Page Fault`, 可能是缺页导致的。

#### 发生缺页时，描述相关重要寄存器的值

假定在S态被处理：

`stval` ：缺页的地址
`spec` ：引发缺页的指令的地址：
`scause` ：异常号（`Instruction Page fault`,  `Load Page Fault`,   `Store/AMO Page Fault`分别对应12 13 15）
`sstratch`: 指向用户空间里的Trap Context

#### Lazy策略的好处

对于没有被使用的内存，就不用加载。一方面节省了物理内存，另一方面节省了加载所需的时间。

#### 连续10GiB

需要 $\dfrac{10GiB}{4kiB} = 2 621 440$页

第3级页表需要 $\dfrac{2 621 440}{512} = 5 120$ 页
第2级页表需要 $\dfrac{5 120}{512} = 10$ 页
第1级页表需要10项，小于一页

总计需要约$5131$页页表，即约$20.04MiB$

#### 怎样实现Lazy策略

在memory set中维护已经调用mmap，但是还没有实际分配物理页的虚拟页编号，以及对应的权限等信息。

在处理page fault的过程中，检查发生page fault的访存地址中，是否属于这种情况。如果是，则根据mmap时的权限信息为其分配一个物理页。


#### 页面被swap
页面被swap时，pte中的v标记被改成了0


### 双页表和单页表
#### 单页表下如何更换页表
把页表的基地址保存在任务控制块里，在切换任务的时候写入`satp`这个csr寄存器中。

#### 单页表下如何控制用户无法访问内核页面
在pte中把对应的U标记设成0

#### 单页表有何优势
节省页表要占用的空间，节省进入trap的开销

#### 双页表实现下，何时更换页表？如果写一个单页表操作系统，何时切换页表
双：用户态和内核态切换、不同进程之间切换时
单：不同进程之间切换时